<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="向着财富与自由前进吧">
    <meta name="author" content="Keep Team">
    
    <title>
        
            cron趟坑之旅 |
        
        Keep Theme
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    
<link rel="stylesheet" href="/fontawesome/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/css/regular.min.css">

    
<link rel="stylesheet" href="/fontawesome/css/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/css/brands.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.xml"};
    KEEP.theme_config = {"toc":{"enable":false,"number":false,"expand_all":false,"init_open":false},"style":{"primary_color":"#0066cc","logo":"/images/logo.svg","favicon":"/images/logo.svg","avatar":"/images/avatar.svg","font_size":null,"font_family":null,"hover":{"shadow":false,"scale":false},"first_screen":{"enable":false,"header_transparent":false,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving.","font_color":null,"hitokoto":false},"scroll":{"progress_bar":false,"percent":false}},"local_search":{"enable":false,"preload":false},"code_copy":{},"code_block":{"tools":{"enable":false,"style":"default"},"highlight_theme":"default"},"side_tools":{},"pjax":{"enable":false},"lazyload":{"enable":false},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.7"},"waline":{"server_url":null,"reaction":false,"version":2}},"post":{"author_label":{"enable":true,"auto":true,"custom_label_list":["Trainee","Engineer","Architect"]},"word_count":{"enable":false,"wordcount":false,"min2read":false},"img_align":"left","copyright_info":false},"version":"3.5.2"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"};
  </script>
<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="/images/logo.svg">
                </a>
            
            <a class="logo-title" href="/">
               Keep Theme
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                    
                </ul>
            </div>
            <div class="mobile">
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            <div class="article-title">
                <span class="title-hover-animation">cron趟坑之旅</span>
            </div>

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="/images/avatar.svg">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">Keep Team</span>
                            
                                <span class="author-label">Lv4</span>
                            
                        </div>
                        <div class="meta-info">
                            
<div class="article-meta-info">
    <span class="article-date article-meta-item">
        
            <i class="fa-regular fa-calendar-plus"></i>&nbsp;
        
        <span class="pc">2021-07-13 21:20:00</span>
        <span class="mobile">2021-07-13 21:20</span>
    </span>
    
        <span class="article-update-date article-meta-item">
        <i class="fas fa-file-pen"></i>&nbsp;
        <span class="pc">2022-10-25 14:08:34</span>
    </span>
    
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/%E4%BA%91/">云</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Python/">Python</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Docker/">Docker</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Linux/">Linux</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content keep-markdown-body">
                <p>  <a class="link" target="_blank" rel="noopener" href="https://baike.sogou.com/m/v8020606.htm">cron<i class="fas fa-external-link-alt"></i></a>是Linux上的定时任务服务，可提供类似Windows上计划任务的功能，嗯，似乎cron的功能会更强大一些。为了能尽可能压榨我那可怜小云的算力，我需要定时运行一些高负载的计算任务，比如XX爬虫（参考<a class="link" target="_blank" rel="noopener" href="https://www.ray0728.cn/2021/07/04/%E5%88%A9%E7%94%A8%E7%88%AC%E8%99%AB%E7%94%9F%E6%88%90%E4%BA%8C%E6%89%8B%E6%88%BF%E7%83%AD%E5%8A%9B%E5%9B%BE/">《二手房热力图》<i class="fas fa-external-link-alt"></i></a>一文），那么自然就趟了cron的坑。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://arts.ray0728.cn/images/2021/07/13/1626167292617_edit_220816660334534.jpg" alt="心塞"></p>
<span id="more"></span>
<h3 id="坑•查看执行结果"><a href="#坑•查看执行结果" class="headerlink" title="坑•查看执行结果"></a>坑•查看执行结果</h3><p>  首先按照网上的各种cron教程，安装cron之后，创建了一个测试计划任务。</p>
<blockquote>
<p><code>*/1 * * * * echo HELLO</code></p>
</blockquote>
<p>  然后用命令<code>cron</code>启动任务，嗯？启动之后似乎没啥反应啊，“哦，对，网上大佬说过cron的结果得通过邮箱查看”，赶紧输入命令<code>mail</code>查看。嗯？然而什么都没显示。不应该啊，难道没运行起来，可是进程当中确实有cron这个进程呢，用<code>crontab  -l</code>也能看见刚刚配置的任务。“嗯，不要慌，反正慌也没啥用”，既然网上大佬说过是通过邮件通知的，那就手动在log目录（泛指Linux中产生日志，邮件的文件目录）中找找呗，最终在<code>/var/spool/mail/</code>中找到日志了。可看见每隔一段时间就有一个HELLO出现。</p>
<p>ps：<strong>可通过命令<code>tail -f /var/spool/mail/mail</code>持续跟踪cron任务执行结果的输出</strong>。</p>
<h3 id="坑•环境变量"><a href="#坑•环境变量" class="headerlink" title="坑•环境变量"></a>坑•环境变量</h3><p>  既然HELLO都可以执行了，那就来一个复杂一点的任务吧。我将需要执行的脚本统一放在了一个Shell脚本当中，脚本大概长下面这个样子。</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">#!/bin/bash
python 我要图片.py
python 我要应用.py
python 我要自行车.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>  然后将这个脚本添加进cron任务。按预想，到时间后会依次执行“我要xx”脚本。</p>
<blockquote>
<p><code>*/1 * * * * iwant.sh</code></p>
</blockquote>
<p>  然而和上一个坑遇到的情况一毛一样，啥都没发生，唉，就说气不气人吧。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://arts.ray0728.cn/images/2021/07/13/1626170157985.png" alt="气人"></p>
<p>  行嘛，既然出了问题那就定位搞呗。之前直接执行echo一切正常，换成Shell脚本就出现问题，猜测是脚本执行失败，那么需要获取具体的错误原因再做进一步分析，通过重定向将错误信息保存至文本当中。发现脚本使用的是系统默认的Python2.x版本，而脚本中需要的库是安装在Python3当中的。嗯，懂了，那我就显式指定Python路径呗。将脚本修改成这个样子。</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">#!/bin/bash
/usr/local/bin/python 我要图片.py
/usr/local/bin/python 我要应用.py
/usr/local/bin/python 我要不知道要什么.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>  再次运行，Python倒是用对了，但是脚本依然报错，提示我某些环境变量找不到（为了便于配置，我将部分参数以环境变量的形式配置在docker-compose.yml当中，程序运行时会直接读取这部分参数），我的第一反应是脚本写错了，可是单独运行又是一切正常。这又是遇到了什么鬼！</p>
<p>  查看cron系统配置（/etc/crontab），简单看了下也没啥毛病呀。</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit t is file
# and files in /etc/cron.d. These files also have usrname fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/
bin:/usr/bin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  这下懵逼了，最怕的就是这种问题，连怎么调试都不知道。直到在网上找到这样的神文<a class="link" target="_blank" rel="noopener" href="https://www.ibm.com/support/pages/cron-environment-and-cron-job-failures">《The Cron Environment and Cron Job Failures》<i class="fas fa-external-link-alt"></i></a>，看这标题怕不就是专门为我而写的吧。</p>
<blockquote>
<p><strong>What is the cron environment?</strong><br><br><br>  Since the cron daemon is a system program that is started by one of the system startup scripts, its environment will not be the same as the environment inherited from the shell when a job is run from the command line. Cron inherits its environment from its parent, which is the init process. But during cron initialization, cron can modify or extend the environment before it runs cron jobs. The default environment for a cron job consists of /etc/environment, and the default shell environment variables such as <kbd><strong>$PATH</strong></kbd>, <kbd><strong>$HOME</strong></kbd> and <kbd><strong>$PWD</strong></kbd>. Information in login files (for example, /etc/profile, ~/.profile and ~/.kshrc, so it is unlikely <kbd><strong>$PATH</strong></kbd> contains login shell directories. If the cron job needs any information in these shell initialization files, these scripts must be sourced at the top of the cron job script.<br><br><br>System limits, also known as ulimits are essential to the cron environment. The ulimits for a cron job are inherited from the root account, and will likely not be the same as the ulimits for a regular user account.<br><br><br><strong>Note</strong>: The at command is often used to test cron jobs. Because the at command is executed from the command line, unlike cron, it will automatically inherit the current environment of the shell.</p>
</blockquote>
<p>  简单来说就是cron是由init进程创建的，因此它的环境变量和init保持一致，而我们在Shell中执行脚本时用到的环境变量相较于系统启动时已有很大的变化，因此cron无法主动获取到新增（或修改）的变量，而在文中介绍的解决办法则是（简单直接）</p>
<blockquote>
<p>Any additional information needed by a cron job can also be added directly at the top of the cron job script. </p>
</blockquote>
<p>  既然蓝色大佬都这么说了，那就搞呗。可是问题又来了</p>
<ul>
<li><p>我需要的环境变量是由docker传递进来的，并非写在profile或bashrc当中，因此不能通过source或自行rc的方式让环境变量生效。</p>
</li>
<li><p>为了便于管理以及安全考虑，所以才将参数修改为docker的环境变量，难道为了cron，我还得硬编码进脚本吗？似乎和初衷相违呢。</p>
</li>
</ul>
<p>  这可咋整？回头再看看文档，终于发现关键的一句话<kbd>The default environment for a cron job consists of /etc/environment</kbd>。如果我能把这个文件同步成最新的变量不就OK了么。有了这个思路，那解决起来就是一句话的事儿了。</p>
<blockquote>
<p>printenv &gt; /etc/enironment</p>
</blockquote>
<p>  是的，没错就这么一句话就搞定cron变量的问题。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://arts.ray0728.cn/images/2021/07/04/b-ssl.duitang.jpg" alt="叉腰"></p>
<h3 id="坑•格式"><a href="#坑•格式" class="headerlink" title="坑•格式"></a>坑•格式</h3><p>  这个坑和前面的比起来只能算小泥坑，对，就是下面这种愉快的小坑。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://arts.ray0728.cn/images/2021/07/13/1626180025683_edit_228041496623536.jpg" alt="愉快的坑"></p>
<p>  对于首次使用cron的新手来说，cron确实不够友好，我第一次在<a class="link" target="_blank" rel="noopener" href="https://www.runoob.com/w3cnote/linux-crontab-tasks.html">菜鸟教程<i class="fas fa-external-link-alt"></i></a>上学习cron的时候，差点把我整自闭，大家可以感受下。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://arts.ray0728.cn/images/2021/07/13/Screenshot_20210713_204538.jpg" alt="菜鸟教程"></p>
<p>  我第一反应是这一堆的 <code>* * *</code> 是啥啊？它怎么就表示每天，每分钟，每小时了啊？这不是在逗我吗？后来才了解到不同位置的 <code>*</code> 有不同的含义（站位的重要性），可每一位具体表示什么呢？网上又出现有歧义的解读，有些说是按秒分时排序，有些说是按分时排序，感觉上在不同的平台，不同的版本的cron配置是不统一的（没确认过）。</p>
<p>  其实完全不用去网上找cron的配置说明，在/etc/crontab中就有详细的描述。</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,ap
 ...
 # |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or
 7) OR sun,mon,tue,wed,thu,fri,sat
 # |  |  |  |  |
 # *  *  *  *  * user-name command to be executed
 17 *    * * *   root    cd / &amp;&amp; run-parts --report /
 tc/cron.hourly
 25 6    * * *   root    test -x /usr/sbin/anacron ||
 ( cd / &amp;&amp; run-parts --report /etc/cron.daily )
 47 6    * * 7   root    test -x /usr/sbin/anacron ||
 ( cd / &amp;&amp; run-parts --report /etc/cron.weekly )
 52 6    1 * *   root    test -x /usr/sbin/anacron ||
 ( cd / &amp;&amp; run-parts --report /etc/cron.monthly )<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>   简单清晰，一看就懂。</p>
<h3 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h3><p>   至此，我的cron趟坑之旅也就快结束了，目前在cron的帮助下，我将周一至周六每天凌晨的时段都安排上了。因为最近搞了一个爬虫，数据量比较大，而我的小云负载又不是那么强，只好拆分了一下，安排在每天凌晨了呗。而这个新爬虫到底干了啥后面再单独写吧。<br> )</p>

            </div>

            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/Python/">#Python</a>&nbsp;
                        </li>
                    
                        <li class="tag-item">
                            <a href="/tags/Docker/">#Docker</a>&nbsp;
                        </li>
                    
                        <li class="tag-item">
                            <a href="/tags/Linux/">#Linux</a>&nbsp;
                        </li>
                    
                </ul>
            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                               rel="prev"
                               href="/2021/07/17/210717-%E5%90%91%E7%9D%80%E4%BA%BA%E7%94%9F%E8%87%AA%E7%94%B1%E5%89%8D%E8%BF%9B%E4%B8%80%E5%B0%8F%E6%AD%A5/"
                            >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                                <span class="title flex-center">
                                <span class="post-nav-title-item">向着人生自由前进一小步</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                               rel="next"
                               href="/2021/07/04/210704-%E5%88%A9%E7%94%A8%E7%88%AC%E8%99%AB%E7%94%9F%E6%88%90%E4%BA%8C%E6%89%8B%E6%88%BF%E7%83%AD%E5%8A%9B%E5%9B%BE/"
                            >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">利用爬虫生成二手房热力图</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                                <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                            </a>
                        </div>
                    
                </div>
            

            
        </div>

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            
<footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
                <span>2020</span> -
            
            2023
            
                &nbsp;<i class="fas fa-heart icon-animate"></i>
                &nbsp;<a href="/">Keep Team</a>
            
        </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.5.2</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>










<div class="post-scripts">
    
        
<script src="/js/post-helper.js"></script>

        
        
    
</div>



</body>
</html>
